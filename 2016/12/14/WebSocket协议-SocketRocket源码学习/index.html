<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> WebSocketåè®®ã€SocketRocketæºç å­¦ä¹  Â· bug world</title><meta name="description" content="WebSocketåè®®ã€SocketRocketæºç å­¦ä¹  - bugå°è‹±é›„"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://antyme.com/atom.xml" title="bug world"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpeg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/cosmos180" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">WebSocketåè®®ã€SocketRocketæºç å­¦ä¹ </h1><div class="post-info">Dec 14, 2016</div><div class="post-content"><p><a href="https://tools.ietf.org/html/rfc6455#section-5.5.1" target="_blank" rel="external">rfc6455 WebSockets æ ‡å‡†</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/WebSockets/Writing_WebSocket_servers" target="_blank" rel="external">ç¼–å†™ WebSocket æœåŠ¡å™¨</a></p>
<h3 id="WebSocketæ¦‚è¿°ã€æ¡æ‰‹"><a href="#WebSocketæ¦‚è¿°ã€æ¡æ‰‹" class="headerlink" title="WebSocketæ¦‚è¿°ã€æ¡æ‰‹"></a>WebSocketæ¦‚è¿°ã€æ¡æ‰‹</h3><p>é¦–å…ˆï¼ŒæœåŠ¡å™¨å¿…é¡»é€šè¿‡æ ‡å‡† TCP å¥—æ¥å­—æ¥ä¾¦å¬å¤–æ¥çš„è¿æ¥è¯·æ±‚ã€‚å–å†³äºä½ çš„å¹³å°ï¼Œå¯èƒ½å·²ç»å¤„ç†å¥½æ¡æ‰‹äº†ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å‡å®šä½ çš„æœåŠ¡ç›‘å¬åœ¨åœ°å€ example.com ï¼Œç«¯å£å· 8000 ä¸Šï¼Œè€Œä¸”èƒ½å¤Ÿå›åº”è·¯å¾„ /chat ä¸Šçš„ GET è¯·æ±‚ã€‚</p>
<blockquote>
<p>è­¦å‘Š: æœåŠ¡å™¨ç›‘å¬ä»»æ„æ‰€é€‰æ‹©çš„ç«¯å£ï¼Œä½†æ˜¯å¦‚æœåœ¨ 80 æˆ–è€… 443 ä¹‹å¤–çš„ç«¯å£ä¸Šï¼Œå¯èƒ½ä¼šåœ¨é˜²ç«å¢™æˆ–è€…ä»£ç†ä¸Šå‡ºé—®é¢˜ã€‚åœ¨ 443 ç«¯å£ä¸Šæ¯”è¾ƒå®¹æ˜“æˆåŠŸï¼Œä½†æ˜¯éœ€è¦å®‰å…¨è¿æ¥ï¼ˆTLS/SSLï¼‰ã€‚å¦å¤–å°±æ˜¯å¤§å¤šæ•°æµè§ˆå™¨ï¼ˆæ¯”å¦‚ Firefox 8+ï¼‰ä¸å…è®¸åœ¨å®‰å…¨é¡µé¢ä¸Šè¿æ¥ä¸å®‰å…¨çš„ WebSocket æœåŠ¡å™¨ã€‚</p>
</blockquote>
<p>æ¡æ‰‹è¿™ä¸€ç¯èŠ‚å°±æ˜¯ WebSockets ä¸Šçš„â€œwebâ€ã€‚å®ƒæ˜¯ä» HTTP åˆ° WS çš„æ¡¥æ¢ã€‚æ¡æ‰‹æ—¶ä¼šåå•†è¿æ¥çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä¸”å¦‚æœæ¡ä»¶ä¸é€‚åˆï¼Œä»»ä½•ä¸€æ–¹éƒ½å¯ä»¥åœ¨æˆåŠŸå»ºç«‹è¿æ¥ä¹‹å‰é€€å‡ºã€‚æœåŠ¡å™¨ä¸€å®šè¦æ¸…æ¥šå®¢æˆ·ç«¯æ‰€è¦æ±‚çš„ä¸€åˆ‡ä¿¡æ¯ï¼Œå¦åˆ™å¯èƒ½ä¼šå‘ç”Ÿå®‰å…¨é—®é¢˜ã€‚</p>
<h5 id="å®¢æˆ·ç«¯æ¡æ‰‹è¯·æ±‚"><a href="#å®¢æˆ·ç«¯æ¡æ‰‹è¯·æ±‚" class="headerlink" title="å®¢æˆ·ç«¯æ¡æ‰‹è¯·æ±‚"></a>å®¢æˆ·ç«¯æ¡æ‰‹è¯·æ±‚</h5><p>å³ä½¿ä½ æ­£åœ¨æ„å»ºä¸€ä¸ªæœåŠ¡ï¼ŒWebSocket æ¡æ‰‹è¯·æ±‚ä»éœ€è¦ç”±å®¢æˆ·ç«¯å‘èµ·ã€‚å› æ­¤ä½ å¿…é¡»çŸ¥é“å¦‚ä½•è§£è¯»å®¢æˆ·ç«¯ä¿¡æ¯ã€‚é¦–å…ˆå®¢æˆ·ç«¯ä¼šå‘é€ç±»ä¼¼è¿™æ ·çš„æ ‡å‡† HTTP è¯·æ±‚ï¼ˆHTTP ç‰ˆæœ¬å·æœ€ä½ä¸º 1.1 ï¼Œè€Œä¸”è¯·æ±‚æ–¹æ³•å¿…é¡»ä¸º GETï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">GET /chat HTTP/1.1</div><div class="line">Host: example.com:8000</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</div><div class="line">Sec-WebSocket-Version: 13</div></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯å¯ä»¥è¯·æ±‚æ‰©å±•å’Œ/æˆ–å­åè®®åŒ–ï¼Œè¯¦è§<a href="https://developer.mozilla.org/zh-CN/docs/WebSockets/Writing_WebSocket_servers#Miscellaneous" target="_blank" rel="external">æ‚é¡¹</a>ã€‚å¦å¤–ï¼Œå¸¸è§„çš„å¤´éƒ¨ä¿¡æ¯å¦‚User-Agent,Referer, Cookie, or authentication ç­‰ä¹Ÿå¯èƒ½ä¼šå‡ºç°ã€‚ä½ å¯ä»¥éšæ„å¤„ç†è¿™äº›å†…å®¹ï¼Œå®ƒä»¬å¹¶ä¸ç›´æ¥å±äºWebScoketçš„ä¸€éƒ¨åˆ†ï¼Œå¿½ç•¥å®ƒä»¬ä¹Ÿæ²¡äº‹ã€‚åœ¨è®¸å¤šçš„å¸¸è§è®¾ç½®ä¸­ï¼Œåå‘ä»£ç†å·²ç»å¯¹å®ƒä»¬è¿›è¡Œäº†å¤„ç†ã€‚</p>
<p>å¦‚æœå­˜åœ¨ä»»ä½•æœªçŸ¥æˆ–è€…é”™è¯¯çš„è¯·æ±‚å¤´ï¼ŒæœåŠ¡å™¨åº”è¯¥å‘é€ä¸€ä¸ª <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#400" target="_blank" rel="external">â€œ400 Bad Requestâ€</a>å¹¶ç«‹å³å…³é—­ socketã€‚åƒå¾€å¸¸ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥åœ¨HTTPå“åº”ä½“ä¸­ç»™å‡ºæ¡æ‰‹å¤±è´¥çš„åŸå› ï¼Œä½†æ˜¯è¿™ä¸ªæ¶ˆæ¯å¯èƒ½ä»æ¥éƒ½ä¸ä¼šæ˜¾ç¤ºå‡ºæ¥ (æµè§ˆå™¨ä¸æ˜¾ç¤º)ã€‚ å¦‚æœæœåŠ¡å™¨æ— æ³•ç†è§£è¯·æ±‚çš„WebSocketsçš„ç‰ˆæœ¬ï¼Œå®ƒåº”è¯¥å‘é€ä¸€ä¸ªåŒ…å«å®ƒèƒ½ç†è§£çš„ç‰ˆæœ¬å·çš„Sec-WebSocket-Versionçš„å¤´éƒ¨ä¿¡æ¯ã€‚ (æœ¬æŒ‡å—è§£é‡Šäº†æœ€æ–°ç‰ˆæœ¬çš„v13)ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹æœ€è®©äººæœŸå¾…çš„å¤´éƒ¨ä¿¡æ¯ï¼ŒSec-WebSocket-Keyã€‚</p>
<blockquote>
<p><em>æç¤º: æ‰€æœ‰çš„æµè§ˆå™¨éƒ½ä¼šå‘é€ Origin è¯·æ±‚å¤´ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥å¤„ç†å®‰å…¨é—®é¢˜ï¼ˆæ¯”å¦‚é»‘åå•ï¼Œç™½åå•ï¼Œoriginæ£€æŸ¥ä¹‹ç±»çš„ï¼‰ç„¶åå‘é€å›å» 403 Forbidden æ¥ç¦æ­¢è¿æ¥ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œéæµè§ˆå™¨å®¢æˆ·ç«¯å¯ä»¥å‘é€ä¼ªé€ çš„ Originã€‚å¤§å¤šæ•°åº”ç”¨å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ° Origin è¯·æ±‚å¤´å°†ä¼šæ‹’ç»è¯·æ±‚ã€‚</em></p>
<p><em>æç¤º: è¯·æ±‚åœ°å€ (ä¾‹å¦‚è¿™é‡Œæ˜¯ /chat ) åœ¨è§„èŒƒä¸­æ²¡æœ‰æ˜ç¡®å®šä¹‰ã€‚æ‰€ä»¥è®¸å¤šäººå·§å¦™çš„åˆ©ç”¨è¿™ç‚¹ï¼Œè®©ä¸€ä¸ªæœåŠ¡å™¨å¤„ç†å¤šä¸ª WebSocket åº”ç”¨ã€‚ä¾‹å¦‚åœ¨ example.com/chat ä¸Šæ˜¯ä¸€ä¸ªèŠå¤©å®¤ï¼Œä¸æ­¤åŒæ—¶åœ¨ /game ä¸Šè¿è¡Œä¸€ä¸ªå¤šäººè”æœºæ¸¸æˆã€‚</em></p>
<p><em>æ³¨æ„: å¸¸è§„ HTTP çŠ¶æ€ç  åªèƒ½åœ¨æ¡æ‰‹å‰ä½¿ç”¨ã€‚æ¡æ‰‹æˆåŠŸåï¼Œä½ å°±å¾—ç”¨ä¸åŒçš„ä»£ç äº† (å‚é˜…è§„èŒƒçš„ç¬¬7ç« ç¬¬4èŠ‚ ).</em></p>
</blockquote>
<h5 id="æœåŠ¡å™¨æ¡æ‰‹å“åº”"><a href="#æœåŠ¡å™¨æ¡æ‰‹å“åº”" class="headerlink" title="æœåŠ¡å™¨æ¡æ‰‹å“åº”"></a>æœåŠ¡å™¨æ¡æ‰‹å“åº”</h5><p>æœåŠ¡å™¨æ”¶åˆ°æ¡æ‰‹è¯·æ±‚åï¼Œå°±åº”è¯¥å‘é€ä¸€ä¸ªçœ‹èµ·æ¥å¾ˆæ€ªå¼‚ (ä½†æ˜¯ä»ç„¶æ˜¯ HTTP ) çš„å“åº”ï¼Œå°±åƒè¿™æ ·ï¼š(è®°å¾—æ¯ä¸€ä¸ªå“åº”å¤´ä¹‹é—´ç”¨ \r\n é—´éš”ï¼Œæœ€åå†æ”¾ä¸€ä¸ª \r\n ç©ºè¡Œ)ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 101 Switching Protocols</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</div></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼ŒæœåŠ¡å™¨åœ¨è¿™é‡Œä¹Ÿå¯ä»¥æŒ‡æ˜ æ‰©å±•/å­åè®®ï¼Œå…·ä½“å‚è€ƒ æ‚é¡¹ã€‚å…¶ä¸­çš„ Sec-WebSocket-Accept æ¯”è¾ƒæœ‰æ„æ€ã€‚è¦ç”Ÿæˆå®ƒï¼Œå°†å®¢æˆ·ç«¯æä¾›çš„ Sec-WebSocket-Key å’Œè§„å®šä¸­æŒ‡æ˜çš„ é­”æ³•å­—ç¬¦ä¸² â€œ258EAFA5-E914-47DA-95CA-C5AB0DC85B11â€ ç®€å•åœ°è¿åœ¨ä¸€èµ·ï¼Œè¿›è¡Œ SHA-1 Hashï¼Œç„¶åç”¨ base64 ç¼–ç ï¼Œè¿”å›ç»“æœå³å¯ã€‚</p>
<blockquote>
<p>ä»…ä¾›å‚è€ƒ: è¿™ä¸ªè¿‡ç¨‹å¯¹äºåˆ¤æ–­æœåŠ¡å™¨æ˜¯å¦æ”¯æŒWebSocketsè¿™ä¸ªå¾ˆæ˜æ˜¾çš„äº‹æƒ…æ¥è¯´å¯èƒ½æ˜¾å¾—å¤ªè¿‡å¤æ‚ã€‚ä½†æ˜¯ï¼Œè¿™éå¸¸é‡è¦ï¼Œå¦‚æœæœåŠ¡å™¨æ¥å—äº†ä¸€ä¸ªWebSocketsçš„é“¾æ¥å´æŒ‰ç…§HTTPè¯·æ±‚æ¥è§£æå¯èƒ½ä¼šå¸¦æ¥å®‰å…¨ä¸Šçš„é—®é¢˜ã€‚</p>
</blockquote>
<p>æ‰€ä»¥å‡è®¾å®¢æˆ·ç«¯å‘æ¥çš„æ˜¯ â€œdGhlIHNhbXBsZSBub25jZQ==â€ï¼ŒæœåŠ¡å™¨å°±å›å¤ â€œs3pPLMBiTxaQ9kYGzzhZRbK+xOo=â€ã€‚ä¸€æ—¦æœåŠ¡å™¨å‘é€å®Œè¿™äº›å“åº”å¤´ï¼Œè¿æ¥å°±å»ºç«‹äº†ï¼Œå¯ä»¥å¼€å§‹äº¤æ¢æ•°æ®äº†ã€‚</p>
<blockquote>
<p>å½“ç„¶æœåŠ¡å™¨ä¹Ÿå¯ä»¥å‘é€ Set-Cookie ä¹‹ç±»çš„å¤´ï¼Œæˆ–è€…å…³äºè®¤è¯çš„è¯·æ±‚ï¼Œæˆ–è€…é€šè¿‡å…¶ä»–çŠ¶æ€ç é‡å®šå‘ï¼Œæ€»ä¹‹åªè¦åœ¨æ¡æ‰‹å“åº”ä¿¡æ¯å‘å‡ºä¹‹å‰éƒ½å¯ä»¥ã€‚</p>
</blockquote>
<h5 id="æŒç»­è¿½è¸ªå®¢æˆ·ç«¯"><a href="#æŒç»­è¿½è¸ªå®¢æˆ·ç«¯" class="headerlink" title="æŒç»­è¿½è¸ªå®¢æˆ·ç«¯"></a>æŒç»­è¿½è¸ªå®¢æˆ·ç«¯</h5><p>è¿™éƒ¨åˆ†å’ŒWebsocketåè®®æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œä½†è¯·åŠ¡å¿…æ³¨æ„ï¼šä½ çš„æœåŠ¡å™¨å¿…é¡»æŒç»­è¿½è¸ªæ¯ä¸ªå®¢æˆ·ç«¯çš„socketä»¥é¿å…è¿›è¡Œé‡å¤çš„æ¡æ‰‹ã€‚åŒä¸€ä¸ªå®¢æˆ·IPåœ°å€å¯èƒ½å°è¯•è¿æ¥å¤šæ¬¡ï¼ˆä½†æœåŠ¡å™¨ä¸ºä¿æŠ¤è‡ªå·±å…å—DoSæ‹’ç»æœåŠ¡å¼æ”»å‡»ï¼Œä¹Ÿå¯æ‹’ç»é‚£äº›è¿‡å¤šè¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯ï¼‰ã€‚</p>
<h3 id="WebSocketåè®®"><a href="#WebSocketåè®®" class="headerlink" title="WebSocketåè®®"></a>WebSocketåè®®</h3><blockquote>
<p>æˆ‘ä»¬çŸ¥é“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½èƒ½åœ¨ä»»æ„æ—¶å€™å‘é€æ•°æ®â€”â€”è¿™æ˜¯WebSocketçš„ç¥å¥‡ä¹‹å¤„ï¼Œè€Œä¸”ä¸ç®¡æ•°æ®æ˜¯ä»å®¢æˆ·ç«¯-&gt;æœåŠ¡ç«¯ï¼Œè¿˜æ˜¯ä»æœåŠ¡ç«¯-&gt;å®¢æˆ·ç«¯ï¼Œæ¯ä¸ªæ•°æ®å¸§ï¼ˆåŒ…ï¼‰çš„æ ¼å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">0                   1                   2                   3</div><div class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div><div class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</div><div class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</div><div class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</div><div class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</div><div class="line">| |1|2|3|       |K|             |                               |</div><div class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</div><div class="line">|     Extended payload length continued, if payload len == 127  |</div><div class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</div><div class="line">|                               |Masking-key, if MASK set to 1  |</div><div class="line">+-------------------------------+-------------------------------+</div><div class="line">| Masking-key (continued)       |          Payload Data         |</div><div class="line">+-------------------------------- - - - - - - - - - - - - - - - +</div><div class="line">:                     Payload Data continued ...                :</div><div class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</div><div class="line">|                     Payload Data continued ...                |</div><div class="line">+---------------------------------------------------------------+</div><div class="line"></div><div class="line">		websocketåè®®ï¼ˆæ•°æ®å¸§æ ¼å¼ï¼‰</div></pre></td></tr></table></figure>
<blockquote>
<p>1ã€å­—æ®µFINï¼šFIN ä½å’Œæ“ä½œç å­—æ®µå…±åŒèµ·åˆ°æŠŠä¸€ä¸ªæŠ¥æ–‡åˆ†æˆå‡ ä¸ªæ•°æ®å¸§å‘é€çš„ä½œç”¨ã€‚è¿™å°±å«åšæŠ¥æ–‡åˆ†æ®µï¼Œåˆ†æ®µåªåœ¨æ“ä½œç ä¸º 0x0ã€0x1ã€0x2 æ—¶æœ‰æ•ˆã€‚ä¸‹é¢demo-1è¯¦ç»†ä»‹ç»å…¶ç”¨æ³•ã€‚</p>
<p>2ã€å­—æ®µRSV1ã€RSV2ã€RSV3å¯å¿½ç•¥ï¼Œé‚£æ˜¯ç”¨äºæ‰©å±•çš„ä¿ç•™å­—æ®µã€‚</p>
<p>3ã€å­—æ®µopcodeï¼šæ“ä½œç (opcode) å­—æ®µå®šä¹‰æ€æ ·è§£é‡Šè´Ÿè½½æ•°æ®ï¼š å­—æ®µå®šä¹‰äº†å¦‚ä½•è§£é‡Šæœ‰æ•ˆè´Ÿè½½æ•°æ®:  0x0 ä¸ºç»§ç»­ï¼Œ0x1 æ–‡æœ¬ (ä»¥ utf-8 ç¼–ç )ï¼Œ0x2 ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œå’Œåé¢å°†è¦è®¨è®ºçš„å…¶ä»–æ‰€è°“â€æ§åˆ¶ä»£ç â€ã€‚åœ¨æ­¤ç‰ˆæœ¬çš„ Websocketï¼ˆå½“å‰ç‰ˆæœ¬å·ä¸º13ï¼‰ï¼Œ0x3 åˆ° 0x7 å’Œ 0xB åˆ° 0xF æ— æ„ä¹‰ã€‚<br><br></p>
<ul>
<li>0x00ï¼šè¡¨ç¤ºè¿™å¸§æ˜¯è¿ç»­çš„å¸§ï¼Œåº”è¯¥æŠŠè¿™å¸§çš„è´Ÿè½½æ•°æ®è¿æ¥åˆ°æ¥æ”¶çš„ä¸Šä¸€å¸§ï¼Œä¸‹é¢demo1æè¿°äº†å…·ä½“çš„ç”¨æ³•ã€‚<br><br></li>
<li>0x01ï¼šè´Ÿè½½æ•°æ®æ˜¯æ–‡æœ¬ã€‚<br><br></li>
<li>0x02ï¼šè´Ÿè½½æ•°æ®æ˜¯äºŒè¿›åˆ¶æ•°æ®ã€‚<br><br></li>
<li>0x08ï¼šå…³é—­è¿æ¥çš„è¯·æ±‚å¸§ï¼Œè¦å…³é—­ä¸€ä¸ªè¿æ¥çš„è¯ï¼Œå®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯å¯ä»¥å‘é€ä¸€ä¸ªå¸¦æœ‰ä¸€æ®µç‰¹æ®Šæ§åˆ¶åºåˆ—æ•°æ®çš„æ§åˆ¶å¸§ï¼Œæ¥å¼€å§‹æŒ¥æ‰‹è¿‡ç¨‹ã€‚ä¸€æ—¦æ¥æ”¶åˆ°è¿™æ ·çš„å¸§ï¼Œå¦ä¸€æ–¹å‘é€å…³é—­å¸§ä½œä¸ºå›åº”ã€‚ä»»ä½•å…³é—­è¿æ¥ä¹‹åçš„æ•°æ®å°†è¢«åºŸå¼ƒã€‚ï¼ˆæˆ‘åœ¨è°ƒè¯•çš„æ—¶å€™è¿™ä¸ªå€¼ç­‰äºâ€™\bâ€™ï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆå—ğŸ˜ï¼‰<br><br></li>
<li>0x9ï¼šPingåŒ…ï¼Œåœ¨æ¡æ‰‹åçš„ä»»ä½•ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œå®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨å¯ä»¥é€‰æ‹©å‘é€ä¸€ä¸ªpingåŒ…ç»™å¯¹æ–¹ã€‚<br> <br></li>
<li>0xAï¼šPongåŒ…ï¼Œå½“pingåŒ…è¢«æ”¶åˆ°æ—¶ï¼Œæ¥å—è€…å¿…é¡»å°½å¯èƒ½å¿«çš„å‘å›pongåŒ…ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæœºåˆ¶æ¥ç¡®å®šå®¢æˆ·ç«¯ä»ç„¶å¤„äºè¿æ¥çŠ¶æ€ã€‚</li>
</ul>
<p>4ã€å­—æ®µMASKï¼šMASKå­—æ®µè¡¨æ˜æŠ¥æ–‡æ˜¯å¦è¢«ç¼–ç ï¼ˆæŒ‰ï¼šå³å‰è¿°XORå¼‚æˆ–åŠ å¯†ï¼‰ã€‚å®¢æˆ·ç«¯å‘æ¥çš„æ¶ˆæ¯åº”è¯¥è¢«æ©è”½ï¼Œæ‰€ä»¥ä½ çš„æœåŠ¡å™¨åº”è¯¥æœŸå¾…è¿™ä¸ªä½ä¸º1ã€‚ï¼ˆäº‹å®ä¸Šï¼Œ<a href="https://tools.ietf.org/html/rfc6455#section-5.1èŠ‚" target="_blank" rel="external">rfc6455 websocketè§„èŒƒçš„5.1</a>è¯´å¦‚å®¢æˆ·ç«¯å‘æ¥â€œæœªæ©è”½â€çš„æŠ¥æ–‡é‚£æœåŠ¡ç«¯åº”è¯¥æ–­å¼€è¿™ä¸ªè¿æ¥ã€‚ï¼‰æœåŠ¡ç«¯å›æŠ¥æ–‡ç»™å®¢æˆ·ç«¯åˆ™ä¸è¦æ©è”½æ•°æ®ï¼Œç›¸åº”çš„MASKä½ä¸º0ã€‚ç¨åæˆ‘ä»¬å°†è§£é‡Šæ©è”½ã€‚æ³¨æ„ï¼šå³ä½¿åœ¨ä¸€ä¸ªå®‰å…¨å¥—æ¥å­—ä¸Šä¼ è¾“æ•°æ®ï¼Œä¹Ÿè¦éµå®ˆä¸Šè¿°è§„åˆ™ã€‚</p>
<p>5ã€å­—æ®µPayload lenï¼ˆ9-15ä½ï¼‰ï¼šè¯»å–è´Ÿè½½æ•°æ®ï¼Œéœ€è¦çŸ¥é“è¯»åˆ°é‚£é‡Œä¸ºæ­¢ã€‚å› æ­¤è·çŸ¥è´Ÿè½½æ•°æ®é•¿åº¦å¾ˆé‡è¦ã€‚è¿™ä¸ªè¿‡ç¨‹ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼Œè¦ä»¥ä¸‹è¿™äº›æ­¥éª¤ï¼š</p>
<ul>
<li>è¯»å–9-15ä½ (åŒ…æ‹¬9å’Œ15ä½æœ¬èº«)ï¼Œå¹¶è½¬æ¢ä¸ºæ— ç¬¦å·æ•´æ•°ã€‚å¦‚æœå€¼å°äºæˆ–ç­‰äº125ï¼Œè¿™ä¸ªå€¼å°±æ˜¯é•¿åº¦ï¼›å¦‚æœæ˜¯ 126ï¼Œè¯·è½¬åˆ°æ­¥éª¤ 2ã€‚å¦‚æœå®ƒæ˜¯ 127ï¼Œè¯·è½¬åˆ°æ­¥éª¤ 3ã€‚</li>
<li>è¯»å–æ¥ä¸‹æ¥çš„ 16 ä½å¹¶è½¬æ¢ä¸ºæ— ç¬¦å·æ•´æ•°ï¼Œå¹¶ä½œä¸ºé•¿åº¦ã€‚</li>
<li>è¯»å–æ¥ä¸‹æ¥çš„ 64 ä½å¹¶è½¬æ¢ä¸ºæ— ç¬¦å·æ•´æ•° (æœ€é«˜æœ‰æ•ˆä½å¿…é¡»ä¸º0)ï¼Œå¹¶ä½œä¸ºé•¿åº¦ã€‚</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Client: FIN=1, opcode=0x1, msg=&quot;hello&quot;</div><div class="line">Server: (process complete message immediately) Hi.</div><div class="line">Client: FIN=0, opcode=0x1, msg=&quot;and a&quot;</div><div class="line">Server: (listening, new message containing text started)</div><div class="line">Client: FIN=0, opcode=0x0, msg=&quot;happy new&quot;</div><div class="line">Server: (listening, payload concatenated to previous message)</div><div class="line">Client: FIN=1, opcode=0x0, msg=&quot;year!&quot;</div><div class="line">Server: (process complete message) Happy new year to you too!</div><div class="line"></div><div class="line">				demo-1</div></pre></td></tr></table></figure>
<p>demo-1æè¿°æœåŠ¡å™¨å¦‚ä½•å›åº”å®¢æˆ·ç«¯å‘é€çš„æ–‡æœ¬æ•°æ®ã€‚ç¬¬ä¸€ä¸ªæŠ¥æ–‡å‘é€äº†å•ä¸ªæ•°æ®å¸§ï¼Œè€Œç¬¬äºŒä¸ªæŠ¥æ–‡é€šè¿‡ä¸‰å¸§å‘é€ã€‚</p>
<h3 id="WebSocket-iOSå¼€æºåº“SocketRocketæºç å­¦ä¹ ï¼ˆfacebookï¼‰"><a href="#WebSocket-iOSå¼€æºåº“SocketRocketæºç å­¦ä¹ ï¼ˆfacebookï¼‰" class="headerlink" title="WebSocket iOSå¼€æºåº“SocketRocketæºç å­¦ä¹ ï¼ˆfacebookï¼‰"></a>WebSocket iOSå¼€æºåº“SocketRocketæºç å­¦ä¹ ï¼ˆ<a href="https://github.com/facebook/SocketRocket" target="_blank" rel="external">facebook</a>ï¼‰</h3><p>æ‰€æœ‰å­¦ä¹ æ–¹æ³•ä¸­æœ‰ä¸€æ¡æ¯”è¾ƒé«˜æ•ˆçš„å°±æ˜¯ç†è®ºè”ç³»å®é™…ï¼ˆä»£ç ï¼‰ã€‚iOSå¼€å‘ä¸­ç”¨çš„æ¯”è¾ƒå¤šçš„æ˜¯websocketåº“æ˜¯Socket.IO-Client-Swiftå’ŒFacebookå¼€æºçš„SocketRocketï¼Œåˆšå¼€å§‹å‡†å¤‡ç ”ç©¶å­¦ä¹ ç¬¬ä¸€ä¸ªï¼Œå‘ç°Socket.IO-Clientä¸æˆ‘ä»¬è‡ªå·±æœåŠ¡ç«¯æä¾›çš„æ¥å£é€‚é…æœ‰ç‚¹é—®é¢˜ï¼Œè€Œä¸”çœ‹äº†ä¸‹æºä»£ç ï¼Œé»˜è®¤ä¼šåœ¨pathåé¢å¼ºåˆ¶æ’å…¥â€™/â€˜ï¼Œè€Œä¸”è¯·æ±‚çš„pathä¹Ÿä¼šå¼ºåˆ¶å¤„ç†ï¼Œæ²¡æœ‰æä¾›è‡ªå®šä¹‰çš„æœºä¼šï¼Œæäº†ä¸€ä¸Šåˆéƒ½è¿ä¸ä¸Šã€‚åœ¨ç»§ç»­ä¹‹å‰å°è¯•äº†ä¸€ä¸‹SocketRocketï¼Œå“‡å¡ï¼Œä¸è¦å¤ªçˆ½ï¼Œä¸æ„§æ˜¯Facebookå•Šï¼äºæ˜¯ç«‹å³â€œæ‚¬å´–å‹’é©¬â€ï¼Œç”¨è¿™ç¯‡æ–‡ç« è®°å½•ä¸‹è‡ªå·±çš„æ”¶è·å’Œç†è§£ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¥è‡ªäºSocketRocketæºç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">- (void)_initializeStreams;</div><div class="line">&#123;</div><div class="line">    assert(_url.port.unsignedIntValue &lt;= UINT32_MAX);</div><div class="line">    uint32_t port = _url.port.unsignedIntValue;</div><div class="line">    if (port == 0) &#123;</div><div class="line">        if (!_secure) &#123;</div><div class="line">            port = 80;</div><div class="line">        &#125; else &#123;</div><div class="line">            port = 443;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    NSString *host = _url.host;</div><div class="line">    </div><div class="line">    CFReadStreamRef readStream = NULL;</div><div class="line">    CFWriteStreamRef writeStream = NULL;</div><div class="line">    </div><div class="line">    CFStreamCreatePairWithSocketToHost(NULL, (__bridge CFStringRef)host, port, &amp;readStream, &amp;writeStream);//åˆ›å»ºäº†socketé€šä¿¡çš„è¾“å…¥å’Œè¾“å‡ºæµ</div><div class="line">    </div><div class="line">    _outputStream = CFBridgingRelease(writeStream);</div><div class="line">    _inputStream = CFBridgingRelease(readStream);</div><div class="line">    </div><div class="line">    //@protocol NSStreamDelegate &lt;NSObject&gt;</div><div class="line">	//	@optional</div><div class="line">	//	- (void)stream:(NSStream *)aStream handleEvent:(NSStreamEvent)eventCode;</div><div class="line">	// @end</div><div class="line">    _inputStream.delegate = self;</div><div class="line">    _outputStream.delegate = self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>_initializeStreamsæ–¹æ³•åˆ›å»ºäº†socketé€šä¿¡çš„è¾“å…¥å’Œè¾“å‡ºstreamã€‚ä½†æ˜¯ï¼Œè¯·çœ‹Appleæ–‡æ¡£å¯¹CFStreamCreatePairWithSocketToHostæ–¹æ³•çš„è¯´æ˜ï¼Œå¾ˆé‡è¦ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Creates readable and writable streams connected to a TCP/IP port of a particular host.</div><div class="line">The streams do not create a socket, resolve the hostname, or connect to the remote host until you open one of the streams.</div><div class="line">Most properties are shared by both streams. Setting a shared property for one stream automatically sets the property for the other.</div></pre></td></tr></table></figure>
<blockquote>
<p>æˆ‘å¤§è‡´ç¿»è¯‘ä¸€ä¸‹ï¼ˆå°´å°¬ï¼‰ï¼šè¿™ä¸ªæ–¹æ³•åœ¨æœ¬æœºä¸ä½¿ç”¨TCP/IPç«¯å£çš„å¯¹æ–¹ä¸»æœºä¹‹é—´ä»…ä»…åˆ›å»ºäº†ç”¨æ¥å†™å…¥å’Œè¯»å–æ•°æ®çš„ä¸¤ä¸ªæµã€‚ä½†æ˜¯è¿™äº›æµå¹¶æ²¡æœ‰åˆ›å»ºçœŸæ­£çš„socketï¼Œæ²¡æœ‰å¼€å§‹è§£æè¿™ä¸ªhostï¼Œä¹Ÿæ²¡æœ‰å¼€å§‹è¿æ¥å¯¹æ–¹ä¸»æœºï¼Œä¸Šè¿°è¿™äº›æ“ä½œä¼šåœ¨è°ƒç”¨opençš„æ—¶å€™æ‰§è¡Œã€‚è¿™ä¸¤ä¸ªæµä¼šå…±äº«å¤§å¤šæ•°çš„å±æ€§ã€‚åªè¦ä¿®æ”¹çš„å±æ€§æ°å¥½æ˜¯å®ƒä»¬å…±äº«çš„ï¼Œåœ¨å®ƒä»¬ä»»ä½•ä¸€ä¸ªä¸­è¿›è¡Œä¿®æ”¹ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠè¯¥å±æ€§ä¿®æ”¹ä¹‹åçš„å€¼åŒæ­¥ç»™å¦å¤–ä¸€æ–¹ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (void)openConnection;</div><div class="line">&#123;</div><div class="line">    [self _updateSecureStreamOptions];</div><div class="line">    </div><div class="line">    if (!_scheduledRunloops.count) &#123;</div><div class="line">        [self scheduleInRunLoop:[NSRunLoop SR_networkRunLoop] forMode:NSDefaultRunLoopMode];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    [_outputStream open];</div><div class="line">    [_inputStream open];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™æ®µä»£ç æ‰å¼€å§‹è¿›è¡ŒçœŸæ­£çš„è¿æ¥ã€‚</p>
<p>ä¸‹é¢è¿™æ®µæ˜¯Appleæ–‡æ¡£å¯¹NSStreamDelegateçš„æè¿°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@protocol NSStreamDelegate &lt;NSObject&gt;</div><div class="line">@optional</div><div class="line">- (void)stream:(NSStream *)aStream handleEvent:(NSStreamEvent)eventCode;</div><div class="line">@end</div></pre></td></tr></table></figure>
<blockquote>
<p>The delegate receives this message when a given event has occurred on a given stream.<br>The delegate receives this message only if theStream is scheduled on a run loop. The message is sent on the stream objectâ€™s thread. The delegate should examine streamEvent to determine the appropriate action it should take.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">- (void)stream:(NSStream *)aStream handleEvent:(NSStreamEvent)eventCode;</div><div class="line">&#123;</div><div class="line">	...</div><div class="line">    [weakSelf safeHandleEvent:eventCode stream:aStream];</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)safeHandleEvent:(NSStreamEvent)eventCode stream:(NSStream *)aStream</div><div class="line">&#123;</div><div class="line">        switch (eventCode) &#123;</div><div class="line">            case NSStreamEventOpenCompleted: &#123;</div><div class="line">	            ...</div><div class="line">	            ...</div><div class="line">	            [self didConnect];</div><div class="line">	            ...</div><div class="line">                [self _pumpWriting];</div><div class="line">                [self _pumpScanner];</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">                </div><div class="line">            case NSStreamEventErrorOccurred: &#123;</div><div class="line">	            ...</div><div class="line">	            ...</div><div class="line">                break;                </div><div class="line">            &#125;</div><div class="line">                </div><div class="line">            case NSStreamEventEndEncountered: &#123;</div><div class="line">                [self _pumpScanner];</div><div class="line">                ...</div><div class="line">                ...</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">                </div><div class="line">            case NSStreamEventHasBytesAvailable: &#123;</div><div class="line">                ...</div><div class="line">                ...</div><div class="line">                [self _pumpScanner];</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">                </div><div class="line">            case NSStreamEventHasSpaceAvailable: &#123;</div><div class="line">	            ...</div><div class="line">	            ...</div><div class="line">                [self _pumpWriting];</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">                </div><div class="line">            default:</div><div class="line">                SRFastLog(@&quot;(default)  %@&quot;, aStream);</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">- (void)didConnect;</div><div class="line">&#123;</div><div class="line">    SRFastLog(@&quot;Connected&quot;);</div><div class="line">    CFHTTPMessageRef request = CFHTTPMessageCreateRequest(NULL, CFSTR(&quot;GET&quot;), (__bridge CFURLRef)_url, kCFHTTPVersion1_1);</div><div class="line">    </div><div class="line">    // Set host first so it defaults</div><div class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Host&quot;), (__bridge CFStringRef)(_url.port ? [NSString stringWithFormat:@&quot;%@:%@&quot;, _url.host, _url.port] : _url.host));</div><div class="line">        </div><div class="line">    NSMutableData *keyBytes = [[NSMutableData alloc] initWithLength:16];</div><div class="line">    SecRandomCopyBytes(kSecRandomDefault, keyBytes.length, keyBytes.mutableBytes);</div><div class="line">    </div><div class="line">    if ([keyBytes respondsToSelector:@selector(base64EncodedStringWithOptions:)]) &#123;</div><div class="line">        _secKey = [keyBytes base64EncodedStringWithOptions:0];</div><div class="line">    &#125; else &#123;</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wdeprecated-declarations&quot;</div><div class="line">        _secKey = [keyBytes base64Encoding];</div><div class="line">#pragma clang diagnostic pop</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    assert([_secKey length] == 24);</div><div class="line"></div><div class="line">    // Apply cookies if any have been provided</div><div class="line">    NSDictionary * cookies = [NSHTTPCookie requestHeaderFieldsWithCookies:[self requestCookies]];</div><div class="line">    for (NSString * cookieKey in cookies) &#123;</div><div class="line">        NSString * cookieValue = [cookies objectForKey:cookieKey];</div><div class="line">        if ([cookieKey length] &amp;&amp; [cookieValue length]) &#123;</div><div class="line">            CFHTTPMessageSetHeaderFieldValue(request, (__bridge CFStringRef)cookieKey, (__bridge CFStringRef)cookieValue);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    // set header for http basic auth</div><div class="line">    if (_url.user.length &amp;&amp; _url.password.length) &#123;</div><div class="line">        NSData *userAndPassword = [[NSString stringWithFormat:@&quot;%@:%@&quot;, _url.user, _url.password] dataUsingEncoding:NSUTF8StringEncoding];</div><div class="line">        NSString *userAndPasswordBase64Encoded;</div><div class="line">        if ([keyBytes respondsToSelector:@selector(base64EncodedStringWithOptions:)]) &#123;</div><div class="line">            userAndPasswordBase64Encoded = [userAndPassword base64EncodedStringWithOptions:0];</div><div class="line">        &#125; else &#123;</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wdeprecated-declarations&quot;</div><div class="line">            userAndPasswordBase64Encoded = [userAndPassword base64Encoding];</div><div class="line">#pragma clang diagnostic pop</div><div class="line">        &#125;</div><div class="line">        _basicAuthorizationString = [NSString stringWithFormat:@&quot;Basic %@&quot;, userAndPasswordBase64Encoded];</div><div class="line">        CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Authorization&quot;), (__bridge CFStringRef)_basicAuthorizationString);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Upgrade&quot;), CFSTR(&quot;websocket&quot;));</div><div class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Connection&quot;), CFSTR(&quot;Upgrade&quot;));</div><div class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Sec-WebSocket-Key&quot;), (__bridge CFStringRef)_secKey);</div><div class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Sec-WebSocket-Version&quot;), (__bridge CFStringRef)[NSString stringWithFormat:@&quot;%ld&quot;, (long)_webSocketVersion]);</div><div class="line">    </div><div class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Origin&quot;), (__bridge CFStringRef)_url.SR_origin);</div><div class="line">    </div><div class="line">    if (_requestedProtocols) &#123;</div><div class="line">        CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Sec-WebSocket-Protocol&quot;), (__bridge CFStringRef)[_requestedProtocols componentsJoinedByString:@&quot;, &quot;]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    [_urlRequest.allHTTPHeaderFields enumerateKeysAndObjectsUsingBlock:^(id key, id obj, BOOL *stop) &#123;</div><div class="line">        CFHTTPMessageSetHeaderFieldValue(request, (__bridge CFStringRef)key, (__bridge CFStringRef)obj);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    NSData *message = CFBridgingRelease(CFHTTPMessageCopySerializedMessage(request));</div><div class="line">    </div><div class="line">    CFRelease(request);</div><div class="line"></div><div class="line">    [self _writeData:message];//socketè¿æ¥æˆåŠŸï¼Œå‘é€å®¢æˆ·ç«¯websocketæ¡æ‰‹è¯·æ±‚</div><div class="line">    [self _readHTTPHeader];//ç­‰å¾…å¹¶å¼€å§‹è¯»å–æœåŠ¡å™¨websocketæ¡æ‰‹å“åº”</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">- (void)_readHTTPHeader;</div><div class="line">&#123;</div><div class="line">    if (_receivedHTTPHeaders == NULL) &#123;</div><div class="line">        _receivedHTTPHeaders = CFHTTPMessageCreateEmpty(NULL, NO);</div><div class="line">    &#125;</div><div class="line">                        </div><div class="line">    [self _readUntilHeaderCompleteWithCallback:^(SRWebSocket *self,  NSData *data) &#123;</div><div class="line">        CFHTTPMessageAppendBytes(_receivedHTTPHeaders, (const UInt8 *)data.bytes, data.length);</div><div class="line">        </div><div class="line">        if (CFHTTPMessageIsHeaderComplete(_receivedHTTPHeaders)) &#123;</div><div class="line">            SRFastLog(@&quot;Finished reading headers %@&quot;, CFBridgingRelease(CFHTTPMessageCopyAllHeaderFields(_receivedHTTPHeaders)));</div><div class="line">            [self _HTTPHeadersDidFinish];</div><div class="line">        &#125; else &#123;</div><div class="line">            [self _readHTTPHeader];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘æœ¬åœ°debugæ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„response headeræ•°æ®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 101 Switching Protocols</div><div class="line">Server: Tengine/2.1.2</div><div class="line">Date: Thu, 15 Dec 2016 08:32:40 GMT</div><div class="line">Connection: upgrade</div><div class="line">Upgrade: websocket</div><div class="line">Sec-WebSocket-Accept: 0EDYPFTXV+u3rkKflAelaATKEvA=</div><div class="line">&lt;space-space-space-space-space-space-space-space-space-space</div></pre></td></tr></table></figure>
<p>æœ€åä¸€è¡Œæ˜¯ä¸€ä¸ªç©ºç™½è¡Œ,æ‰€ä»¥åˆ¤æ–­æ˜¯http headeræ˜¯å¦ç»“æŸçš„æ ‡å¿—å°±æ˜¯â€\r\n\r\nâ€ï¼Œè¯·æŸ¥çœ‹æºç 1262è¡Œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (void)_HTTPHeadersDidFinish;</div><div class="line">&#123;</div><div class="line">    NSInteger responseCode = CFHTTPMessageGetResponseStatusCode(_receivedHTTPHeaders);    </div><div class="line">    if (responseCode &gt;= 400) &#123;</div><div class="line">	    ...</div><div class="line">	    ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">	...    </div><div class="line">    self.readyState = SR_OPEN;    </div><div class="line">    if (!_didFail) &#123;</div><div class="line">        [self _readFrameNew];//websocketåå•†å®Œæ¯•ï¼Œå¼€å§‹è¯»å–æ­£å¼æ•°æ®ã€‚</div><div class="line">    &#125;</div><div class="line">    [self _performDelegateBlock:^&#123;</div><div class="line">        if ([self.delegate respondsToSelector:@selector(webSocketDidOpen:)]) &#123;</div><div class="line">            [self.delegate webSocketDidOpen:self];</div><div class="line">        &#125;;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆªæ­¢åˆ°è¿™é‡Œï¼Œwebsocketåå•†å®Œæ¯•ï¼Œå¼€å§‹è¯»å–æ­£å¼æ•°æ®ã€‚å½“æ—¶ä»£ç çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™æˆ‘ä¹Ÿæ¶ˆé™¤äº†ä¸€ä¸ªå†…å¿ƒçš„ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆå¯¹é¢AndroidåŒäº‹åœ¨websocketè¿æ¥è¿‡ç¨‹ä¸­httpæŠ“åŒ…è½¯ä»¶å¯ä»¥æŠ“åˆ°ï¼Œè€Œæˆ‘ç”¨SocketRocketåˆ™å®Œå…¨æŠ“ä¸åˆ°ï¼ŸåŸå› å°±æ˜¯ï¼šæˆ‘ä»¬iOSæ‰‹æœºä¸æœåŠ¡å™¨ä¹‹é—´å·²ç»å»ºç«‹äº†ä¸€æ¡é•¿è¿æ¥ï¼Œç„¶åè‡ªå·±ç»„è£…websocketçš„http headerå‘é€å‡ºå»çš„ã€‚æ‰€ä»¥æ™®é€šçš„httpæŠ“åŒ…è½¯ä»¶åªèƒ½æŠ“ç©ºæ°”ï¼Œæƒ³è¦æŠ“æˆ‘ä»¬çš„åŒ…ï¼Œå¾—Wiresharkç­‰è¿™ç§æ›´å±Œçš„æŠ“åŒ…å·¥å…·æ‰è¡Œã€‚ï¼ˆæ·±æ·±çš„é„™è§†äº†ä¸€çœ¼å¯¹é¢çš„Androiderï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (void)_readFrameNew;</div><div class="line">&#123;</div><div class="line">    dispatch_async(_workQueue, ^&#123;</div><div class="line">        [_currentFrameData setLength:0];        </div><div class="line">        _currentFrameOpcode = 0;</div><div class="line">        _currentFrameCount = 0;</div><div class="line">        _readOpCount = 0;</div><div class="line">        _currentStringScanPosition = 0;        </div><div class="line">        [self _readFrameContinue];</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">- (void)_readFrameContinue;</div><div class="line">&#123;</div><div class="line">    assert((_currentFrameCount == 0 &amp;&amp; _currentFrameOpcode == 0) || (_currentFrameCount &gt; 0 &amp;&amp; _currentFrameOpcode &gt; 0));</div><div class="line"></div><div class="line">    [self _addConsumerWithDataLength:2 callback:^(SRWebSocket *self, NSData *data) &#123;</div><div class="line">        __block frame_header header = &#123;0&#125;;</div><div class="line">        </div><div class="line">        const uint8_t *headerBuffer = data.bytes;</div><div class="line">        assert(data.length &gt;= 2);</div><div class="line">        </div><div class="line">        if (headerBuffer[0] &amp; SRRsvMask) &#123;</div><div class="line">            [self _closeWithProtocolError:@&quot;Server used RSV bits&quot;];</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        uint8_t receivedOpcode = (SROpCodeMask &amp; headerBuffer[0]);</div><div class="line">        </div><div class="line">        BOOL isControlFrame = (receivedOpcode == SROpCodePing || receivedOpcode == SROpCodePong || receivedOpcode == SROpCodeConnectionClose);</div><div class="line">        </div><div class="line">        if (!isControlFrame &amp;&amp; receivedOpcode != 0 &amp;&amp; self-&gt;_currentFrameCount &gt; 0) &#123;</div><div class="line">            [self _closeWithProtocolError:@&quot;all data frames after the initial data frame must have opcode 0&quot;];</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (receivedOpcode == 0 &amp;&amp; self-&gt;_currentFrameCount == 0) &#123;</div><div class="line">            [self _closeWithProtocolError:@&quot;cannot continue a message&quot;];</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        header.opcode = receivedOpcode == 0 ? self-&gt;_currentFrameOpcode : receivedOpcode;</div><div class="line">        </div><div class="line">        header.fin = !!(SRFinMask &amp; headerBuffer[0]);</div><div class="line">        </div><div class="line">        </div><div class="line">        header.masked = !!(SRMaskMask &amp; headerBuffer[1]);</div><div class="line">        header.payload_length = SRPayloadLenMask &amp; headerBuffer[1];</div><div class="line">        </div><div class="line">        headerBuffer = NULL;</div><div class="line">        </div><div class="line">        if (header.masked) &#123;</div><div class="line">            [self _closeWithProtocolError:@&quot;Client must receive unmasked data&quot;];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        size_t extra_bytes_needed = header.masked ? sizeof(_currentReadMaskKey) : 0;</div><div class="line">        </div><div class="line">        if (header.payload_length == 126) &#123;</div><div class="line">            extra_bytes_needed += sizeof(uint16_t);</div><div class="line">        &#125; else if (header.payload_length == 127) &#123;</div><div class="line">            extra_bytes_needed += sizeof(uint64_t);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (extra_bytes_needed == 0) &#123;</div><div class="line">            [self _handleFrameHeader:header curData:self-&gt;_currentFrameData];</div><div class="line">        &#125; else &#123;</div><div class="line">            [self _addConsumerWithDataLength:extra_bytes_needed callback:^(SRWebSocket *self, NSData *data) &#123;</div><div class="line">                size_t mapped_size = data.length;</div><div class="line">                #pragma unused (mapped_size)</div><div class="line">                const void *mapped_buffer = data.bytes;</div><div class="line">                size_t offset = 0;</div><div class="line">                </div><div class="line">                if (header.payload_length == 126) &#123;</div><div class="line">                    assert(mapped_size &gt;= sizeof(uint16_t));</div><div class="line">                    uint16_t newLen = EndianU16_BtoN(*(uint16_t *)(mapped_buffer));</div><div class="line">                    header.payload_length = newLen;</div><div class="line">                    offset += sizeof(uint16_t);</div><div class="line">                &#125; else if (header.payload_length == 127) &#123;</div><div class="line">                    assert(mapped_size &gt;= sizeof(uint64_t));</div><div class="line">                    header.payload_length = EndianU64_BtoN(*(uint64_t *)(mapped_buffer));</div><div class="line">                    offset += sizeof(uint64_t);</div><div class="line">                &#125; else &#123;</div><div class="line">                    assert(header.payload_length &lt; 126 &amp;&amp; header.payload_length &gt;= 0);</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                if (header.masked) &#123;</div><div class="line">                    assert(mapped_size &gt;= sizeof(_currentReadMaskOffset) + offset);</div><div class="line">                    memcpy(self-&gt;_currentReadMaskKey, ((uint8_t *)mapped_buffer) + offset, sizeof(self-&gt;_currentReadMaskKey));</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                [self _handleFrameHeader:header curData:self-&gt;_currentFrameData];</div><div class="line">            &#125; readToCurrentFrame:NO unmaskBytes:NO];</div><div class="line">        &#125;</div><div class="line">    &#125; readToCurrentFrame:NO unmaskBytes:NO];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SocketRocketæœ‰ä¸¤ä¸ªâ€œæ³µâ€æ–¹æ³•ï¼š_pumpWritingã€_pumpScannerï¼Œè¿™ä¸¤ä¸ªâ€œæ³µâ€ä¿è¯äº†websocketæ•°æ®çš„å‘é€ã€æ¥å—åŠŸèƒ½ã€‚è¿™ä¸¤ä¸ªâ€œæ³µâ€çš„ä»£ç å†™çš„å¾ˆä¸é”™å“¦ï¼Œå¾ˆå·§å¦™çš„è§£å†³äº†socketæ•°æ®çš„æ¥æ”¶è§£æå’Œå‘é€ï¼ŒæŒºæœ‰å‚è€ƒæ„ä¹‰çš„ï¼Œæ¯•ç«Ÿäººå®¶æ˜¯Facebookçš„ã€‚</p>
<hr>
<p>æœ‰ç©ºå†ç»§ç»­ï¼Œé‡Œé¢è¿˜æ˜¯æœ‰å¾ˆå¤šå°ç»†èŠ‚çš„ï¼Œè¿™äº›å°ç»†èŠ‚çš„å¤„ç†æ–¹æ³•ä¹Ÿæ˜¯å€¼å¾—æˆ‘ä»¬å­¦ä¹ çš„ã€‚</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/12/18/iOS-Blocksçš„å®ç°åŸç†/" class="prev">PREV</a><a href="/2016/11/30/iOSåˆ¤æ–­å½“å‰è¾“å…¥æ³•æ˜¯ç³»ç»Ÿè‡ªå¸¦è¿˜æ˜¯ç¬¬ä¸‰æ–¹/" class="next">NEXT</a></div><div data-thread-key="2016/12/14/WebSocketåè®®-SocketRocketæºç å­¦ä¹ /" data-title="WebSocketåè®®ã€SocketRocketæºç å­¦ä¹ " data-url="http://antyme.com/2016/12/14/WebSocketåè®®-SocketRocketæºç å­¦ä¹ /" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"antyme"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>Â© 2012 - 2016 <a href="http://antyme.com">bugå°è‹±é›„</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>